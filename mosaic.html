<!DOCTYPE html>
<html>
<head>
  <script src='http://code.jquery.com/jquery-latest.min.js'></script>
  <script src='color-thief.js'></script>
  <script>
  var canvas = document.createElement('canvas'); // In memory canvas
  var ctx    = canvas.getContext("2d");

  var largeImage = new Image();
  var size = 100; //px

  //hold image objects
  var parts = []; //store split images (base64 url)
  function ImageObject(dataUrl, i, j, link, img) {
    this.url = dataUrl;
    this.x = i;
    this.y = j;
    this.link = link;
    this.img = img;
    // this.r
    // this.g
    // this.b

  }

  var file,reader;
  //upload file
  function previewFile() {
    file = $('#fileinput')[0].files[0];
    reader = new FileReader();

    reader.onloadend = function () {
      $('#preview').prop('src',reader.result);
      largeImage.src = reader.result;
      //colorSearch();
    }

    if (file) {
      reader.readAsDataURL(file);
    } else {
      $('#preview').prop('src', '');
    }
    largeImage.onload = split_N;

  }


  function split_N(){
    var Nx = Math.floor(largeImage.width / size),
        Ny = Math.floor(largeImage.height / size);
    var offsetX = largeImage.width % size;
    var offsetY = largeImage.height % size; //calculate offset for image
    canvas.width  = size;
    canvas.height = size;
    console.log('width: ', largeImage.width, 'height: ', largeImage.height);
    console.log('offset x: ', offsetX, 'offset y: ', offsetY);
    console.log('Num x: ', Nx, 'Num y: ', Ny);

    for(var j=0; j<Ny; j++){
      var temp = [];
        for(var i=0; i<Nx; i++){
          var x = -size*i - offsetX/2.0;
          var y = -size*j - offsetY/2.0;
          ctx.drawImage(this, x, y, size*Nx+offsetX, size*Ny+offsetY); // img, x, y, w, h

          var url = canvas.toDataURL();

          //temp.push(url);
          var img = new Image();
          img.src = url;

          parts.push(new ImageObject(url, i, j, '', null));
          $('#pieces').append('<img src=\"'+url+'\" id=\"test'+i+''+j+'\" alt=\"split images\"/>');

          img.onload = colorSearch;
      }
      //parts.push( temp );     // ("image/jpeg") for jpeg
      //console.log( temp.length );
      $('#pieces').append('<br>');
    }
  }
  //on each image
  //colorSearch(img);
  //separate function for retrieved images
  function colorSearch() {
    var colorThief = new ColorThief();
    var color = colorThief.getColor(this);
    //console.log(this.src);
    //find array position of image and append color to
    for(var i = 0; i < parts.length; i++){
      if(parts[i].url == this.src){
        parts[i].r = color[0];
        parts[i].g = color[1];
        parts[i].b = color[2];
        //console.log(i);
        break;
      }
    }
    return color;
  }
  //store instagram images and color
  var insta = [];

  //compare image colors
  function compare(alpha,beta) {
    // var aDist = sqrt(alpha.r*alpha.r + alpha.g*alpha.g + alpha.b*alpha.b);
    // var bDist = sqrt(beta.r*beta.r + beta.g*beta.g + beta.b*beta.b);
    var distance = sqrt(Math.pow(alpha.r-beta.r,2) + Math.pow(alpha.g-beta.g,2) + Math.pow(alpha.b-beta.b,2))
    return distance;
  }

  //enter two imageobjects, return color difference
  $('document').ready(function(){
    $('#create').click(function(){
      //var searchTerm = 'nyc';
      //for loop to search through entered terms
      //max 5
      //default term is nyc
      //33 limit
      //$.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/tag/"+searchTerm+"?count=100", fillInstaCallback);
        //searchTerm = 'cats';
      //$.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/tag/"+searchTerm+"?count=100",fillInstaCallback);
      var numTerms = 2;
      //var deferreds = getInstagramResults(numTerms);
      getInstagramResults(numTerms);
      // $.when.apply(null, deferreds).done(function() {
      //     console.log('instagram searches complete! :D');
      //     //assign and compare images
      //
      //   });
      });
    });

  function colorSearchInsta(img) {
    // var deferred = [];
    //   // for(var i = 0; i < insta.length; i++){
    //   //   def.push(colorSearchInsta())
    //   // }
    //   //append to array of imageobjects
    //   //search through entire downloaded array of images
    // for(var i = 0; i < insta.length; i++){
    //     var colorThief = new ColorThief();
    //     var color = colorThief.getColor(insta[i].img);
    //     deferred.push(color);
    //     insta[i].r = color[0];
    //     insta[i].g = color[1];
    //     insta[i].b = color[2];
    //     console.log(i);
    //   }
    //   return deferred;

    var colorThief = new ColorThief();
    var color = colorThief.getColor(img);
      //append to array of imageobjects
      //search through entire downloaded array of images
    for(var i = 0; i < insta.length; i++){
        if(insta[i].url == img.src){
          insta[i].r = color[0];
          insta[i].g = color[1];
          insta[i].b = color[2];
          console.log(i);
        }
      }
      return color;
    }
    //called for each instagram search
    //boolColor true when last instagram search is completed

  var deferreds = [];
  function fillInstaCallback(response, boolColor){
      var count = 0;
      for(var i=0; i<response.length; i++) {
        var img = new Image();
        img.crossOrigin = "Anonymous";

        //on the last image


        // count++;
        // if(count==response.length-1 && boolColor){
        //     img.onload = function(){
        //     //call colorSearchInsta on array of all downloaded images
        //     //returns array of deferred objects
        //
        //     //call colorsearchinsta now all images have been downloaded
        //     //loop through image array and call colorSearchInsta
        //     //push to def
        //     //console.log('boolColor',boolColor);
        //
        //   // console.log('count',count);
        //
        //     var deferreds = [];
        //     deferreds = colorSearchInsta();
        //
        //     $.when.apply(null, deferreds).done(function() {
        //         console.log('color searches complete! :D');
        //       //assign and compare images
        //     });
        //   }
        // }

        img.onload = function(){
            count++;
            deferreds.push(colorSearchInsta(this));

            if(boolColor && (count==response.length-1)){

              $.when.apply(null, deferreds).done(function() {
                  console.log('color searches complete! :D');
                //assign and compare images
              });
            }
          }

        var url = response[i].images.thumbnail.url;
        img.src = url;

        insta.push(new ImageObject(url, -1, -1, response[i].link, img));

        //console.log(i);
      }




      //return deferreds;
    }
  function getInstagramResults(numTerms) {
      //var def = [];
      var searchTerm = 'nyc';
      var count = 0;

      for (var i = 0; i < numTerms; i++) {

        // def.push(
        //   $.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/tag/"+searchTerm+"?count=100", fillInstaCallback)
        // );
        $.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/tag/"+searchTerm+"?count=100", function(response){
          //console.log(count, numTerms);
          fillInstaCallback(response, count++ == numTerms-1);
        });
        //$.getJSON("http://cooper-union-instagram-proxy.herokuapp.com/search/tag/"+searchTerm+"?count=100", fillInstaCallback);

        searchTerm = 'cats';
      }



      //var deferreds = def;

      // $.when.apply(null, def).done(function() {
      //     console.log('color searches complete! :D');
      //     //assign and compare images
      //
      //   });
      //return def;
  }



  </script>
</head>
<style>
  img{
    margin-left: 2px;
    margin-right: 2px;
  }
</style>
<body>
  <input type='file' id ='fileinput' onchange='previewFile()'><br>

  <img src='' id='preview' alt='Image preview...'/>
  <br>
  <div id='pieces'>

  </div>
  <button id='create'>Generate mosaic!</button>

</body>
</html>
